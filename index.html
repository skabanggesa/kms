<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMS Digital - Sistem Pengurusan Kokurikulum</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Loader Animation */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Utility */
        .hidden { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Custom UI */
        .btn-primary { @apply bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm font-semibold; }
        .input-field { @apply w-full border border-slate-300 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm; }
        .card { @apply bg-white p-6 rounded-xl shadow-sm border border-slate-100; }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="global-loader" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] hidden backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center animate-bounce-small">
            <div class="loader mb-4"></div>
            <p id="loader-text" class="font-bold text-slate-700">Memproses data...</p>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-blue-900 via-slate-800 to-slate-900 p-4">
        <div class="bg-white/95 backdrop-blur-md p-8 rounded-2xl shadow-2xl w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <img src="kms.png" onerror="this.src='https://via.placeholder.com/100?text=LOGO'" alt="Logo Sekolah" class="w-24 h-24 mx-auto mb-4 object-contain">
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">KMS Digital</h1>
                <p class="text-slate-500 font-medium text-sm mt-1">Sistem Pengurusan Kokurikulum</p>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Emel Pengguna</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-3 top-3.5 text-slate-400"></i>
                        <input type="email" id="login-email" class="input-field pl-10 bg-slate-50" placeholder="cikgu@sekolah.edu.my">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Kata Laluan</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-3.5 text-slate-400"></i>
                        <input type="password" id="login-password" class="input-field pl-10 bg-slate-50" placeholder="••••••">
                    </div>
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold hover:bg-blue-700 transition transform active:scale-95 shadow-lg shadow-blue-500/30 mt-2">
                    LOG MASUK
                </button>
            </div>
            <p class="text-center text-xs text-slate-400 mt-8">&copy; 2024 KMS Digital System</p>
        </div>
    </div>

    <div id="main-app" class="hidden flex h-full relative">
        
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass-effect"></div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-slate-900 text-white transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col shadow-2xl">
            <div class="p-6 border-b border-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center font-bold">K</div>
                    <div>
                        <h2 class="font-bold text-lg leading-none">KMS Panel</h2>
                        <p class="text-[10px] text-slate-400 uppercase tracking-wider mt-1">Versi 2.0</p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
                <p class="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-2">Menu Utama</p>
                <button onclick="showPage('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <div class="w-6 text-center"><i class="fas fa-home text-blue-400"></i></div> Utama
                </button>
                <button onclick="showPage('students')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <div class="w-6 text-center"><i class="fas fa-user-graduate text-green-400"></i></div> Data Murid
                </button>
                <button onclick="showPage('attendance')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <div class="w-6 text-center"><i class="fas fa-clipboard-check text-yellow-400"></i></div> Kehadiran
                </button>
                <button onclick="showPage('reports')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <div class="w-6 text-center"><i class="fas fa-camera text-purple-400"></i></div> Laporan
                </button>
                <button onclick="showPage('annual_plans')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <div class="w-6 text-center"><i class="fas fa-calendar-check text-pink-400"></i></div> Perancangan
                </button>
                <button onclick="showPage('merit')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <div class="w-6 text-center"><i class="fas fa-medal text-orange-400"></i></div> Rekod Merit
                </button>
                <button onclick="showPage('analysis')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                    <div class="w-6 text-center"><i class="fas fa-print text-red-400"></i></div> Cetakan
                </button>
                
                <div id="admin-menu-section" class="hidden">
                    <p class="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-6 border-t border-slate-800 pt-6">Pentadbir</p>
                    <button onclick="showPage('users')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3 text-slate-300 hover:text-white">
                        <div class="w-6 text-center"><i class="fas fa-users-cog text-cyan-400"></i></div> Pengurusan Guru
                    </button>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <div class="flex items-center gap-3 px-2 mb-3">
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs"><i class="fas fa-user"></i></div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold truncate" id="user-role-name">User</p>
                        <p class="text-[10px] text-slate-400 truncate" id="user-role-label">Guru</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full bg-red-600/10 text-red-400 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg transition text-sm font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-sign-out-alt"></i> Log Keluar
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 w-full">
            
            <header class="bg-white border-b px-6 py-4 flex justify-between items-center shadow-sm z-20 sticky top-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h2 class="text-xl font-bold text-slate-800 truncate" id="header-title">Papan Pemuka</h2>
                </div>
                <button onclick="loadAllData()" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </header>

            <div id="content-scroll" class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
                
                <div id="page-dashboard" class="page-section animate-fade-in space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="card border-l-4 border-blue-500 flex items-center gap-4">
                            <div class="bg-blue-50 p-3 rounded-full text-blue-600"><i class="fas fa-users fa-lg"></i></div>
                            <div><p class="text-xs font-bold text-slate-400 uppercase">Murid</p><h3 class="text-2xl font-black text-slate-800" id="dash-student-count">0</h3></div>
                        </div>
                        <div class="card border-l-4 border-green-500 flex items-center gap-4">
                            <div class="bg-green-50 p-3 rounded-full text-green-600"><i class="fas fa-check-circle fa-lg"></i></div>
                            <div><p class="text-xs font-bold text-slate-400 uppercase">Kehadiran</p><h3 class="text-2xl font-black text-slate-800" id="dash-attendance-count">0</h3></div>
                        </div>
                        <div class="card border-l-4 border-purple-500 flex items-center gap-4">
                            <div class="bg-purple-50 p-3 rounded-full text-purple-600"><i class="fas fa-camera fa-lg"></i></div>
                            <div><p class="text-xs font-bold text-slate-400 uppercase">Laporan</p><h3 class="text-2xl font-black text-slate-800" id="dash-activity-count">0</h3></div>
                        </div>
                        <div class="card border-l-4 border-pink-500 flex items-center gap-4">
                            <div class="bg-pink-50 p-3 rounded-full text-pink-600"><i class="fas fa-calendar-alt fa-lg"></i></div>
                            <div><p class="text-xs font-bold text-slate-400 uppercase">Plan</p><h3 class="text-2xl font-black text-slate-800" id="dash-plan-count">0</h3></div>
                        </div>
                    </div>

                    <div class="card overflow-hidden">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Statistik Mengikut Unit</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="bg-slate-50 text-slate-600 uppercase font-bold text-xs">
                                    <tr>
                                        <th class="p-3 border-b">Unit</th>
                                        <th class="p-3 border-b text-center">Murid</th>
                                        <th class="p-3 border-b text-center">Kehadiran</th>
                                        <th class="p-3 border-b text-center">Laporan</th>
                                        <th class="p-3 border-b text-center">Plan</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-unit-breakdown" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="page-students" class="page-section hidden space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex gap-2">
                            <input type="file" id="csv-input" accept=".csv" class="hidden" onchange="handleCSVImport(this)">
                            <button onclick="document.getElementById('csv-input').click()" class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700 shadow"><i class="fas fa-file-csv mr-2"></i>Import CSV</button>
                            <button onclick="openStudentModal()" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-700 shadow"><i class="fas fa-plus mr-2"></i>Murid</button>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <input type="text" id="search-student" onkeyup="renderStudentTable()" placeholder="Cari..." class="input-field max-w-xs">
                            <select id="filter-student-unit" onchange="renderStudentTable()" class="input-field w-32"><option value="">Semua</option></select>
                        </div>
                    </div>
                    
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50 border-b">
                                    <tr><th class="p-4 font-bold">Nama</th><th class="p-4 font-bold">Tingkatan</th><th class="p-4 font-bold">Jantina</th><th class="p-4 font-bold">Unit</th><th class="p-4 text-center">Aksi</th></tr>
                                </thead>
                                <tbody id="student-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t text-xs text-slate-500" id="student-count-display"></div>
                    </div>
                </div>

                <div id="page-attendance" class="page-section hidden space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1">
                            <div class="card sticky top-4">
                                <h3 class="font-bold text-lg mb-4 text-blue-600 border-b pb-2">Daftar Kehadiran</h3>
                                <form onsubmit="submitAttendance(event)" class="space-y-4">
                                    <input type="date" id="att-date" class="input-field" required>
                                    <select id="att-unit" class="input-field" onchange="loadStudentsForAttendance()" required><option value="">Pilih Unit...</option></select>
                                    <input type="text" id="att-title" class="input-field" placeholder="Tajuk Aktiviti" required>
                                    <div class="bg-slate-50 p-3 rounded-lg border h-60 flex flex-col">
                                        <div class="flex justify-between text-xs mb-2 font-bold text-slate-500">
                                            <span>Senarai Nama</span>
                                            <div><span onclick="selectAllAttendance(true)" class="cursor-pointer text-blue-600 mr-2">Semua</span><span onclick="selectAllAttendance(false)" class="cursor-pointer text-red-500">Tiada</span></div>
                                        </div>
                                        <div id="att-student-list" class="flex-1 overflow-y-auto space-y-1 custom-scrollbar">
                                            <p class="text-xs text-center text-slate-400 mt-10">Pilih unit dahulu.</p>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn-primary w-full">SIMPAN REKOD</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div class="card p-0 overflow-hidden">
                                <div class="p-4 bg-slate-50 border-b font-bold text-sm">Sejarah Rekod (Terkini)</div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm text-left whitespace-nowrap">
                                        <thead class="bg-slate-50 border-b"><tr><th class="p-3">Tarikh</th><th class="p-3">Unit</th><th class="p-3">Aktiviti</th><th class="p-3 text-center">Hadir</th><th class="p-3 text-center">Aksi</th></tr></thead>
                                        <tbody id="attendance-history-body" class="divide-y divide-slate-100"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-annual_plans" class="page-section hidden space-y-6">
                    <div class="card border-l-4 border-pink-500">
                        <h3 class="font-bold text-lg mb-4 text-pink-700">Tambah Perancangan</h3>
                        <form onsubmit="submitPlan(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="date" id="plan-date" class="input-field" required>
                            <input type="text" id="plan-title" class="input-field" placeholder="Program" required>
                            <select id="plan-unit" class="input-field" required><option value="">Pilih Unit...</option></select>
                            <select id="plan-status" class="input-field"><option value="Perancangan">Perancangan</option><option value="Sedang Berjalan">Sedang Berjalan</option><option value="Selesai">Selesai</option><option value="Ditunda">Ditunda</option></select>
                            <textarea id="plan-desc" class="input-field md:col-span-2" placeholder="Objektif..." rows="2"></textarea>
                            <button type="submit" class="btn-primary md:col-span-2">SIMPAN</button>
                        </form>
                    </div>
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="bg-slate-50 border-b"><tr><th class="p-3">Tarikh</th><th class="p-3">Program</th><th class="p-3">Unit</th><th class="p-3">Status</th><th class="p-3">Catatan</th><th class="p-3 text-center">Aksi</th></tr></thead>
                                <tbody id="plans-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="page-merit" class="page-section hidden space-y-6">
                    <div class="card border-l-4 border-orange-500">
                        <h3 class="font-bold text-lg mb-4 text-orange-700">Rekod Pencapaian</h3>
                        <form onsubmit="submitMerit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500">Nama Murid</label><select id="merit-student" class="input-field" required><option value="">Pilih...</option></select></div>
                            <input type="text" id="merit-title" class="input-field" placeholder="Acara / Pertandingan" required>
                            <select id="merit-unit" class="input-field" required><option value="">Pilih Unit...</option></select>
                            <select id="merit-desc" class="input-field"><option value="Penyertaan">Penyertaan</option><option value="Johan">Johan</option><option value="Naib Johan">Naib Johan</option><option value="Ketiga">Ketiga</option></select>
                            <select id="merit-venue" class="input-field"><option value="Sekolah">Sekolah</option><option value="Daerah">Daerah</option><option value="Negeri">Negeri</option><option value="Kebangsaan">Kebangsaan</option></select>
                            <button type="submit" class="btn-primary md:col-span-2">SIMPAN</button>
                        </form>
                    </div>
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="bg-slate-50 border-b"><tr><th class="p-3">Nama</th><th class="p-3">Acara</th><th class="p-3">Pencapaian</th><th class="p-3">Peringkat</th><th class="p-3 text-center">Aksi</th></tr></thead>
                                <tbody id="merit-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="page-reports" class="page-section hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">Senarai Laporan</h3>
                        <button onclick="openReportModal()" class="btn-primary text-sm"><i class="fas fa-plus mr-2"></i>Baru</button>
                    </div>
                    <div id="reports-grid" class="space-y-4"></div>
                </div>

                <div id="page-analysis" class="page-section hidden space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="card hover:border-blue-300 cursor-pointer transition flex items-center gap-4" onclick="printAnalysis('attendance')">
                            <div class="bg-blue-100 p-4 rounded-full text-blue-600"><i class="fas fa-clipboard-list fa-2x"></i></div>
                            <div><h3 class="font-bold">Analisis Kehadiran</h3><p class="text-xs text-slate-500">Cetak laporan kehadiran penuh.</p></div>
                        </div>
                        <div class="card hover:border-pink-300 cursor-pointer transition flex items-center gap-4" onclick="printAnalysis('plans')">
                            <div class="bg-pink-100 p-4 rounded-full text-pink-600"><i class="fas fa-calendar-alt fa-2x"></i></div>
                            <div><h3 class="font-bold">Perancangan Tahunan</h3><p class="text-xs text-slate-500">Status program & takwim.</p></div>
                        </div>
                        <div class="card hover:border-orange-300 cursor-pointer transition flex items-center gap-4" onclick="printAnalysis('merit')">
                            <div class="bg-orange-100 p-4 rounded-full text-orange-600"><i class="fas fa-medal fa-2x"></i></div>
                            <div><h3 class="font-bold">Rekod Pencapaian</h3><p class="text-xs text-slate-500">Senarai pemenang.</p></div>
                        </div>
                        <div class="card hover:border-purple-300 cursor-pointer transition flex items-center gap-4" onclick="printAnalysis('full_reports')">
                            <div class="bg-purple-100 p-4 rounded-full text-purple-600"><i class="fas fa-book-open fa-2x"></i></div>
                            <div><h3 class="font-bold">Laporan Bergambar</h3><p class="text-xs text-slate-500">Kompilasi semua laporan.</p></div>
                        </div>
                    </div>
                </div>

                <div id="page-users" class="page-section hidden space-y-6">
                    <div id="btn-add-user-container" class="flex justify-end">
                        <button onclick="openUserModal('add')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow flex items-center gap-2"><i class="fas fa-plus"></i> Tambah Guru</button>
                    </div>
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-slate-50 border-b"><tr><th class="p-4">Nama</th><th class="p-4 text-center">Peranan</th><th class="p-4">Unit</th><th class="p-4 text-right">Aksi</th></tr></thead>
                                <tbody id="users-table-body" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-student" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h3 class="font-bold text-lg mb-4">Maklumat Murid</h3>
            <form onsubmit="saveStudent(event)" class="space-y-3">
                <input type="text" id="std-name" class="input-field" placeholder="Nama Penuh" required>
                <div class="grid grid-cols-2 gap-3">
                    <select id="std-gender" class="input-field"><option value="L">Lelaki</option><option value="P">Perempuan</option></select>
                    <input type="number" id="std-year" class="input-field" placeholder="Tingkatan" required>
                </div>
                <input type="text" id="std-unit" class="input-field" placeholder="Unit Uniform" required>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('modal-student')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Batal</button>
                    <button type="submit" class="btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-report" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Laporan Aktiviti</h3>
<form onsubmit="saveReport(event)" class="space-y-4">
    
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh Aktiviti</label>
            <input type="date" id="rpt-date" class="input-field w-full bg-slate-50" required onchange="autoFillReportFromAttendance()">
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Unit</label>
            <select id="rpt-unit" class="input-field w-full bg-slate-50" required onchange="autoFillReportFromAttendance()">
                <option value="">Pilih Unit...</option>
            </select>
        </div>
    </div>

    <div>
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tajuk Laporan</label>
        <input type="text" id="rpt-title" class="input-field w-full" placeholder="Cth: Latihan Kawad Kaki" required>
    </div>

    <div>
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Senarai Nama Murid</label>
        <textarea id="rpt-names" class="input-field w-full h-24 text-xs font-mono" placeholder="Nama murid akan masuk automatik..."></textarea>
    </div>

    <div>
        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Laporan Ringkas / Ulasan</label>
        <textarea id="rpt-desc" class="input-field w-full h-24" placeholder="Sila taip laporan ringkas aktiviti di sini..."></textarea>
    </div>
    
    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Gambar Laporan</label>
        <div class="flex gap-2 mb-2">
            <button type="button" onclick="toggleImgMode('url')" class="text-xs bg-white border px-3 py-1 rounded shadow-sm hover:bg-gray-50">Guna URL</button>
            <button type="button" onclick="toggleImgMode('file')" class="text-xs bg-white border px-3 py-1 rounded shadow-sm hover:bg-gray-50">Upload Fail</button>
        </div>
        <input type="text" id="rpt-img-url" class="input-field w-full" placeholder="https://...">
        <input type="file" id="rpt-img-file" class="input-field w-full hidden" accept="image/*" onchange="convertBase64(this)">
        <input type="hidden" id="rpt-img-final">
    </div>

    <div class="flex justify-end gap-3 pt-4 border-t">
        <button type="button" onclick="closeModal('modal-report')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition">Batal</button>
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition">Hantar Laporan</button>
    </div>
</form>
        </div>
    </div>
    
    <div id="modal-view-report" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-4xl h-[85vh] flex flex-col md:flex-row overflow-hidden shadow-2xl relative">
            <button onclick="closeModal('modal-view-report')" class="absolute top-4 right-4 bg-white/80 rounded-full p-2 z-10 hover:bg-red-500 hover:text-white transition"><i class="fas fa-times"></i></button>
            <div class="md:w-2/5 bg-slate-100 flex flex-col border-r">
                <div class="h-64 md:h-1/2 bg-slate-200 relative">
                    <img id="view-rpt-img" src="" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3">
                        <span id="view-rpt-unit" class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded">UNIT</span>
                    </div>
                </div>
                <div class="p-4 flex-1 overflow-y-auto">
                    <p class="text-xs font-bold text-slate-500 uppercase">Tarikh</p>
                    <p id="view-rpt-date" class="font-bold text-slate-800 mb-4">-</p>
                    <p class="text-xs font-bold text-slate-500 uppercase">Kehadiran</p>
                    <div class="bg-white border rounded p-2 h-32 overflow-y-auto text-xs font-mono mt-1 shadow-inner">
                        <p id="view-rpt-names">-</p>
                    </div>
                </div>
            </div>
            <div class="md:w-3/5 p-6 overflow-y-auto bg-white">
                <h2 id="view-rpt-title" class="text-2xl font-black text-slate-800 mb-4 border-b pb-2">Title</h2>
                <div class="prose prose-sm max-w-none text-slate-700">
                    <p id="view-rpt-desc" class="whitespace-pre-wrap text-justify leading-relaxed">...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-user" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h3 id="user-modal-title" class="font-bold text-lg mb-4 text-slate-800">Urus Guru</h3>
            <form id="form-user" class="space-y-3">
                <input type="hidden" id="user-doc-id">
                <input type="text" id="user-name" class="input-field" placeholder="Nama Guru" required>
                <div class="grid grid-cols-2 gap-3">
                    <input type="email" id="user-email" class="input-field" placeholder="Emel" required>
                    <input type="text" id="user-password" class="input-field" placeholder="Password" required>
                </div>
                <select id="user-role" class="input-field bg-slate-50"><option value="teacher">Teacher</option><option value="admin">Admin</option></select>
                <div class="pt-2 border-t mt-2">
                    <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Unit Kendalian (Isi '-' jika tiada)</p>
                    <input type="text" id="user-uniform" class="input-field mb-2" placeholder="Uniform (cth: Pengakap)">
                    <input type="text" id="user-club" class="input-field mb-2" placeholder="Kelab (cth: B.Inggeris)">
                    <input type="text" id="user-sport" class="input-field" placeholder="Sukan (cth: Bola Sepak)">
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeModal('modal-user')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Batal</button>
                    <button type="submit" class="btn-primary w-full">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzLf0WBthx-icFZuzOHMJQvKyGCvCTRqD4-QY1kT1aBPo87k3hWkH215zldGQTHsn6D/exec";
        
        let currentUser = null;
        let globalData = { students: [], attendance: [], reports: [], records: [], users: [], annual_plans: [] };

        // --- UTILS ---
        function showLoader(show) { 
            const el = document.getElementById('global-loader'); 
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); 
        }

        async function callApi(action, collection, data = {}) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST', body: JSON.stringify({ action, collection, data: JSON.stringify(data) })
                });
                return await response.json();
            } catch (error) {
                alert("Ralat sambungan internet.");
                return { status: "error" };
            }
        }

        function cleanFirestoreData(dataArray) {
            return dataArray.map(item => {
                const cleanItem = {};
                for (const key in item) {
                    let val = item[key];
                    if (typeof val === 'string' && (val.includes('stringValue') || val.includes('integerValue'))) {
                        try {
                            const parsed = JSON.parse(val);
                            if (parsed.stringValue !== undefined) val = parsed.stringValue;
                            else if (parsed.integerValue !== undefined) val = parsed.integerValue;
                        } catch (e) {}
                    }
                    cleanItem[key] = val;
                }
                return cleanItem;
            });
        }

        function sortDataByDate(dataList) {
            return dataList.sort((a, b) => {
                const dateA = new Date(a.date); const dateB = new Date(b.date);
                if (dateB - dateA !== 0) return dateB - dateA; 
                return (a.unit || "").localeCompare(b.unit || "");
            });
        }

        // --- AUTH ---
        async function handleLogin() {
            const email = document.getElementById('login-email').value.trim();
            const pass = document.getElementById('login-password').value.trim();
            if (!email || !pass) return alert("Sila isi emel dan kata laluan.");

            showLoader(true);
            const res = await callApi('read', 'users');
            showLoader(false);

            if (res.status === 'success') {
                globalData.users = cleanFirestoreData(res.data);
                const user = globalData.users.find(u => u.email.toLowerCase() === email.toLowerCase() && String(u.password) === String(pass));
                
                if (user) {
                    currentUser = user;
                    currentUser.myUnits = [];
                    if (user.uniform && user.uniform !== '-') currentUser.myUnits.push(user.uniform);
                    if (user.club && user.club !== '-') currentUser.myUnits.push(user.club);
                    if (user.sport && user.sport !== '-') currentUser.myUnits.push(user.sport);
                    
                    localStorage.setItem('kms_user', JSON.stringify(currentUser));
                    initApp();
                } else {
                    alert("Emel atau kata laluan salah.");
                }
            } else {
                alert("Gagal menghubungi server.");
            }
        }

        function logout() { localStorage.removeItem('kms_user'); location.reload(); }

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            document.getElementById('user-role-name').innerText = currentUser.name;
            document.getElementById('user-role-label').innerText = currentUser.role === 'admin' ? 'PENTADBIR' : 'GURU PENASIHAT';
            
            if(currentUser.role === 'admin') document.getElementById('admin-menu-section').classList.remove('hidden');
            
            loadAllData();
        }

        async function loadAllData() {
            showLoader(true);
            try {
                // Gunakan Promise.all supaya semua jalan serentak
                const results = await Promise.all([
                    callApi('read', 'students_master'),
                    callApi('read', 'attendance'),
                    callApi('read', 'reports'),
                    callApi('read', 'records'),
                    callApi('read', 'annual_plans'),
                    callApi('read', 'users') // PENTING: Untuk admin
                ]);

                globalData.students = cleanFirestoreData(results[0].data || []);
                globalData.attendance = sortDataByDate(cleanFirestoreData(results[1].data || []));
                globalData.reports = sortDataByDate(cleanFirestoreData(results[2].data || []));
                globalData.records = sortDataByDate(cleanFirestoreData(results[3].data || []));
                globalData.annual_plans = sortDataByDate(cleanFirestoreData(results[4].data || []));
                globalData.users = cleanFirestoreData(results[5].data || []);

                updateDashboard();
                showPage('dashboard');
            } catch (e) { console.error(e); alert("Ralat data."); }
            showLoader(false);
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            const myUnits = currentUser.role === 'admin' ? null : currentUser.myUnits;
            const filterFn = (item) => !myUnits || myUnits.includes(item.unit);

            document.getElementById('dash-student-count').innerText = globalData.students.filter(filterFn).length;
            document.getElementById('dash-activity-count').innerText = globalData.reports.filter(filterFn).length;
            document.getElementById('dash-attendance-count').innerText = globalData.attendance.filter(filterFn).length;
            document.getElementById('dash-plan-count').innerText = globalData.annual_plans.filter(filterFn).length;

            const breakdownBody = document.getElementById('dashboard-unit-breakdown');
            let targetUnits = currentUser.role === 'admin' ? [...new Set(globalData.students.map(s => s.unit))].sort() : currentUser.myUnits;
            
            breakdownBody.innerHTML = targetUnits.map(unitName => {
                const sCount = globalData.students.filter(s => s.unit === unitName).length;
                const aCount = globalData.attendance.filter(a => a.unit === unitName).length;
                const rCount = globalData.reports.filter(r => r.unit === unitName).length;
                const pCount = globalData.annual_plans.filter(p => p.unit === unitName).length;
                return `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-3 font-semibold text-slate-700">${unitName}</td>
                    <td class="p-3 text-center"><span class="bg-blue-100 text-blue-800 py-1 px-3 rounded-full text-xs font-bold">${sCount}</span></td>
                    <td class="p-3 text-center"><span class="bg-green-100 text-green-800 py-1 px-3 rounded-full text-xs font-bold">${aCount}</span></td>
                    <td class="p-3 text-center"><span class="bg-purple-100 text-purple-800 py-1 px-3 rounded-full text-xs font-bold">${rCount}</span></td>
                    <td class="p-3 text-center"><span class="bg-pink-100 text-pink-800 py-1 px-3 rounded-full text-xs font-bold">${pCount}</span></td>
                </tr>`;
            }).join('');
        }

        // --- STUDENTS ---
        function renderStudentTable() {
            const filter = document.getElementById('search-student').value.toLowerCase();
            const unitFilter = document.getElementById('filter-student-unit').value;
            let data = globalData.students;
            if (currentUser.role !== 'admin') data = data.filter(s => currentUser.myUnits.includes(s.unit));
            
            const filtered = data.filter(s => (s.name.toLowerCase().includes(filter) || s.unit.toLowerCase().includes(filter)) && (unitFilter === "" || s.unit === unitFilter));
            
            document.getElementById('student-table-body').innerHTML = filtered.map(s => `
                <tr class="hover:bg-slate-50 border-b transition"><td class="p-4 font-medium">${s.name}</td><td class="p-4 text-slate-500">${s.year}</td><td class="p-4">${s.gender}</td><td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">${s.unit}</span></td><td class="p-4 text-center"><button onclick="deleteData('students_master','${s.doc_id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr>
            `).join('');
            
            document.getElementById('student-count-display').innerText = `Jumlah: ${filtered.length} murid`;
            
            // Populate Dropdown Unit
            const unitDropdown = document.getElementById('filter-student-unit');
            if(unitDropdown.children.length === 1) {
                const units = currentUser.role === 'admin' ? [...new Set(globalData.students.map(s=>s.unit))].sort() : currentUser.myUnits;
                units.forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = u; unitDropdown.appendChild(opt); });
            }
        }
        function openStudentModal() { document.getElementById('modal-student').classList.replace('hidden','flex'); }
        async function saveStudent(e) {
            e.preventDefault();
            const data = { name: document.getElementById('std-name').value, gender: document.getElementById('std-gender').value, year: document.getElementById('std-year').value, unit: document.getElementById('std-unit').value };
            showLoader(true);
            await callApi('create', 'students_master', data);
            closeModal('modal-student'); loadAllData();
        }

        // --- ATTENDANCE ---
        function loadStudentsForAttendance() {
            const unit = document.getElementById('att-unit').value;
            const container = document.getElementById('att-student-list');
            const students = globalData.students.filter(s => s.unit === unit);
            container.innerHTML = students.length ? students.map(s => `<div class="flex items-center gap-2 p-1 hover:bg-slate-100 rounded"><input type="checkbox" value="${s.name}" class="att-checkbox h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"><label class="text-sm w-full">${s.name}</label></div>`).join('') : '<p class="text-red-400 text-center text-xs mt-4">Tiada murid.</p>';
        }
        function selectAllAttendance(checked) { document.querySelectorAll('.att-checkbox').forEach(cb => cb.checked = checked); }
        async function submitAttendance(e) {
            e.preventDefault();
            const names = Array.from(document.querySelectorAll('.att-checkbox:checked')).map(cb => cb.value).join(", ");
            if(!names) return alert("Pilih murid dahulu.");
            showLoader(true);
            await callApi('create', 'attendance', { date: document.getElementById('att-date').value, unit: document.getElementById('att-unit').value, title: document.getElementById('att-title').value, names: names, year: new Date().getFullYear() });
            loadAllData();
        }
        function renderAttendanceHistory() {
            let data = globalData.attendance;
            if(currentUser.role !== 'admin') data = data.filter(a => currentUser.myUnits.includes(a.unit));
            document.getElementById('attendance-history-body').innerHTML = data.map(a => `<tr class="border-b"><td class="p-3">${a.date}</td><td class="p-3"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold">${a.unit}</span></td><td class="p-3 max-w-xs truncate">${a.title}</td><td class="p-3 text-center font-bold text-green-600">${a.names ? a.names.split(',').length : 0}</td><td class="p-3 text-center"><button onclick="deleteData('attendance','${a.doc_id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            
            const sel = document.getElementById('att-unit');
            if (sel.children.length <= 1) {
                const units = currentUser.role === 'admin' ? [...new Set(globalData.students.map(s=>s.unit))].sort() : currentUser.myUnits;
                units.forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = u; sel.appendChild(opt); });
            }
        }

        // --- ANNUAL PLANS ---
        function renderAnnualPlans() {
            let data = globalData.annual_plans;
            if (currentUser.role !== 'admin') data = data.filter(p => currentUser.myUnits.includes(p.unit));
            
            document.getElementById('plans-table-body').innerHTML = data.map(p => {
                let color = p.status === 'Selesai' ? 'bg-green-100 text-green-800' : p.status === 'Sedang Berjalan' ? 'bg-blue-100 text-blue-800' : p.status === 'Ditunda' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                return `<tr class="border-b hover:bg-slate-50">
                    <td class="p-3 text-xs text-gray-500">${p.date}</td>
                    <td class="p-3 font-medium">${p.title}</td>
                    <td class="p-3 text-xs">${p.unit}</td>
                    <td class="p-3"><select onchange="updatePlanStatus('${p.doc_id}', this.value)" class="text-xs font-bold border rounded px-2 py-1 cursor-pointer outline-none ${color}">
                        <option value="Perancangan" ${p.status==='Perancangan'?'selected':''}>Perancangan</option>
                        <option value="Sedang Berjalan" ${p.status==='Sedang Berjalan'?'selected':''}>Sedang Berjalan</option>
                        <option value="Selesai" ${p.status==='Selesai'?'selected':''}>Selesai</option>
                        <option value="Ditunda" ${p.status==='Ditunda'?'selected':''}>Ditunda</option>
                    </select></td>
                    <td class="p-3 text-xs max-w-xs truncate">${p.description}</td>
                    <td class="p-3 text-center"><button onclick="deleteData('annual_plans','${p.doc_id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            }).join('');
            
            const sel = document.getElementById('plan-unit');
            if (sel.children.length <= 1) {
                const units = currentUser.role === 'admin' ? [...new Set(globalData.students.map(s=>s.unit))].sort() : currentUser.myUnits;
                units.forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = u; sel.appendChild(opt); });
            }
        }
        async function submitPlan(e) {
            e.preventDefault();
            const data = { date: document.getElementById('plan-date').value, title: document.getElementById('plan-title').value, unit: document.getElementById('plan-unit').value, status: document.getElementById('plan-status').value, description: document.getElementById('plan-desc').value };
            showLoader(true); await callApi('create', 'annual_plans', data); loadAllData();
        }
        async function updatePlanStatus(docId, newStatus) {
            showLoader(true); await callApi('update', 'annual_plans', { doc_id: docId, status: newStatus }); loadAllData();
        }

        // --- MERIT ---
        async function submitMerit(e) {
            e.preventDefault();
            const sel = document.getElementById('merit-student');
            showLoader(true);
            await callApi('create', 'records', { names: sel.options[sel.selectedIndex].text, title: document.getElementById('merit-title').value, unit: document.getElementById('merit-unit').value, description: document.getElementById('merit-desc').value, venue: document.getElementById('merit-venue').value });
            loadAllData();
        }
        function renderMerit() {
            let data = globalData.records;
            if(currentUser.role !== 'admin') data = data.filter(r => currentUser.myUnits.includes(r.unit));
            document.getElementById('merit-table-body').innerHTML = data.map(r => `<tr class="border-b"><td class="p-3">${r.names}</td><td class="p-3">${r.title}</td><td class="p-3"><span class="bg-yellow-100 text-yellow-800 px-2 rounded text-xs">${r.description}</span></td><td class="p-3">${r.venue}</td><td class="p-3 text-center"><button onclick="deleteData('records','${r.doc_id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            
            const sel = document.getElementById('merit-student'); sel.innerHTML = '<option value="">Pilih Murid...</option>';
            let students = globalData.students; if(currentUser.role !== 'admin') students = students.filter(s => currentUser.myUnits.includes(s.unit));
            students.forEach(s => { const opt = document.createElement('option'); opt.value = s.doc_id; opt.innerText = s.name; sel.appendChild(opt); });
            
            const selUnit = document.getElementById('merit-unit'); selUnit.innerHTML = '<option value="">Pilih Unit...</option>';
            const units = currentUser.role === 'admin' ? [...new Set(globalData.students.map(s=>s.unit))].sort() : currentUser.myUnits;
            units.forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = u; selUnit.appendChild(opt); });
        }

// --- REPORTS ---
        
        // 1. FUNGSI BARU: Buka Modal & Isi Dropdown Unit
        function openReportModal() { 
            // Buka Modal
            document.getElementById('modal-report').classList.replace('hidden','flex'); 
            
            // Reset Borang
            document.getElementById('rpt-date').value = "";
            document.getElementById('rpt-title').value = "";
            document.getElementById('rpt-names').value = "";
            document.getElementById('rpt-desc').value = "";
            document.getElementById('rpt-img-final').value = "";
            
            // Masukkan Senarai Unit ke dalam Dropdown
            const sel = document.getElementById('rpt-unit');
            sel.innerHTML = '<option value="">Pilih Unit...</option>'; 
            
            // Logik: Admin dapat semua unit, Guru dapat unit dia sahaja
            const units = currentUser.role === 'admin' ? 
                          [...new Set(globalData.students.map(s=>s.unit))].sort() : 
                          currentUser.myUnits;
            
            units.forEach(u => { 
                const opt = document.createElement('option'); 
                opt.value = u; 
                opt.innerText = u; 
                sel.appendChild(opt); 
            });
        }

// --- FUNGSI AUTO-FILL (DIPERBAIKI: Masalah Format Tarikh ISO) ---
function autoFillReportFromAttendance() {
    const dateVal = document.getElementById('rpt-date').value; // Cth: "2026-02-25"
    const unitVal = document.getElementById('rpt-unit').value;

    // 1. Pastikan input tidak kosong
    if (!dateVal || !unitVal) return;

    console.log("MENCARI PADANAN...", dateVal, unitVal);

    // 2. Cari padanan dalam data kehadiran
    const record = globalData.attendance.find(a => {
        if (!a.date) return false;

        // --- PEMBAIKAN UTAMA DI SINI ---
        // Tukar format database (ISO Long) kepada YYYY-MM-DD
        let dbDateStr = a.date;
        
        // Jika data ada format masa (ada huruf 'T'), kita proses jadi tarikh tempatan
        if (a.date.includes('T')) {
            const d = new Date(a.date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dbDateStr = `${year}-${month}-${day}`;
        }
        // -------------------------------

        // Bandingkan
        const dateMatch = (dbDateStr === dateVal);
        const unitMatch = (a.unit.trim().toLowerCase() === unitVal.trim().toLowerCase());
        
        return dateMatch && unitMatch;
    });

    // 3. Jika Jumpa
    if (record) {
        console.log("REKOD DIJUMPAI!", record);
        
        // Isi Tajuk
        document.getElementById('rpt-title').value = record.title || "";
        
        // Isi Nama
        const nameField = document.getElementById('rpt-names');
        nameField.value = record.names || "";
        
        // Visual Feedback (Kelip Hijau)
        nameField.classList.add('bg-green-100');
        setTimeout(() => nameField.classList.remove('bg-green-100'), 500);

    } else {
        console.log("Masih tiada rekod. Pastikan tarikh kehadiran di Google Sheet betul.");
    }
}

        // 3. KEKALKAN: Fungsi Simpan Laporan
        async function saveReport(e) {
            e.preventDefault();
            showLoader(true);
            await callApi('create', 'reports', { 
                date: document.getElementById('rpt-date').value, 
                title: document.getElementById('rpt-title').value, 
                unit: document.getElementById('rpt-unit').value, 
                description: document.getElementById('rpt-desc').value,
                names: document.getElementById('rpt-names').value, 
                image: document.getElementById('rpt-img-final').value || document.getElementById('rpt-img-url').value 
            });
            closeModal('modal-report'); loadAllData();
        }

        // 4. KEKALKAN: Fungsi Papar Senarai Laporan
        function renderReports() {
             let data = globalData.reports;
             if(currentUser.role !== 'admin') data = data.filter(r => currentUser.myUnits.includes(r.unit));
             const container = document.getElementById('reports-grid');
             if(data.length === 0) container.innerHTML = '<div class="text-center p-6 text-slate-400">Tiada laporan dijumpai.</div>';
             else {
                 container.innerHTML = data.map(r => `
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4 flex items-center justify-between group hover:border-blue-300 transition">
                        <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="viewReportDetails('${r.doc_id}')">
                            ${r.image ? `<img src="${r.image}" class="w-12 h-12 rounded-lg object-cover border">` : `<div class="w-12 h-12 rounded-lg bg-slate-100 flex items-center justify-center text-slate-400"><i class="fas fa-image"></i></div>`}
                            <div>
                                <h4 class="font-bold text-slate-800 group-hover:text-blue-600 transition">${r.title}</h4>
                                <div class="flex gap-2 text-xs text-slate-500 mt-1">
                                    <span><i class="far fa-calendar mr-1"></i>${r.date}</span>
                                    <span class="bg-slate-100 px-2 rounded text-slate-600 font-bold">${r.unit}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteData('reports','${r.doc_id}')" class="text-slate-300 hover:text-red-500 p-2"><i class="fas fa-trash"></i></button>
                    </div>
                 `).join('');
             }
        }

        // 5. KEKALKAN: Fungsi Lihat Detail Laporan
        function viewReportDetails(id) {
            const report = globalData.reports.find(r => r.doc_id === id);
            if(!report) return;
            document.getElementById('view-rpt-img').src = report.image || 'https://via.placeholder.com/800x400?text=Tiada+Gambar';
            document.getElementById('view-rpt-title').innerText = report.title;
            document.getElementById('view-rpt-date').innerText = report.date;
            document.getElementById('view-rpt-unit').innerText = report.unit;
            document.getElementById('view-rpt-desc').innerText = report.description || "Tiada huraian tambahan.";
            document.getElementById('view-rpt-names').innerText = (report.names || "Tiada senarai nama.");
            document.getElementById('modal-view-report').classList.replace('hidden', 'flex');
        }

        // --- USERS MANAGEMENT (ADMIN) ---
        function renderUsers() {
            if (currentUser.role !== 'admin') return;
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = globalData.users.map(u => `
                <tr class="border-b hover:bg-slate-50 transition text-sm">
                    <td class="p-4">
                        <div class="font-bold text-slate-800">${u.name}</div>
                        <div class="text-xs text-slate-500">${u.email}</div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'} px-2 py-1 rounded text-[10px] font-bold uppercase">${u.role}</span>
                    </td>
                    <td class="p-4 text-xs">
                        <div class="flex flex-wrap gap-1">
                            ${(u.uniform && u.uniform!=='-') ? `<span class="bg-slate-100 px-2 py-0.5 rounded border">${u.uniform}</span>` : ''}
                            ${(u.club && u.club!=='-') ? `<span class="bg-slate-100 px-2 py-0.5 rounded border">${u.club}</span>` : ''}
                            ${(u.sport && u.sport!=='-') ? `<span class="bg-slate-100 px-2 py-0.5 rounded border">${u.sport}</span>` : ''}
                        </div>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="openUserModal('edit', '${u.doc_id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteData('users', '${u.doc_id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openUserModal(mode, docId = null) {
            const modal = document.getElementById('modal-user');
            const form = document.getElementById('form-user');
            const title = document.getElementById('user-modal-title');
            form.reset(); document.getElementById('user-doc-id').value = "";
            
            if (mode === 'edit') {
                title.innerText = "Kemaskini Guru";
                const user = globalData.users.find(u => u.doc_id === docId);
                if (user) {
                    document.getElementById('user-doc-id').value = user.doc_id;
                    document.getElementById('user-name').value = user.name;
                    document.getElementById('user-email').value = user.email;
                    document.getElementById('user-password').value = user.password;
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('user-uniform').value = user.uniform || "-";
                    document.getElementById('user-club').value = user.club || "-";
                    document.getElementById('user-sport').value = user.sport || "-";
                }
            } else {
                title.innerText = "Tambah Guru Baru";
            }
            modal.classList.replace('hidden', 'flex');
        }

        document.getElementById('form-user').onsubmit = async function(e) {
            e.preventDefault();
            const docId = document.getElementById('user-doc-id').value;
            const userData = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                uniform: document.getElementById('user-uniform').value || "-",
                club: document.getElementById('user-club').value || "-",
                sport: document.getElementById('user-sport').value || "-"
            };
            showLoader(true);
            if (docId) {
                await callApi('update', 'users', { doc_id: docId, ...userData });
            } else {
                userData.uid = "u_" + Date.now();
                await callApi('create', 'users', userData);
            }
            closeModal('modal-user'); loadAllData();
        };

        // --- PRINTING (FIXED GROUP BY UNIT & FULL NAMES) ---
        function printAnalysis(type) {
             let generatedDate = new Date().toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
             let contentHTML = "";
             
             let dataAttendance = globalData.attendance;
             let dataPlans = globalData.annual_plans;
             let dataRecords = globalData.records;
             let dataReports = globalData.reports;

             if(currentUser.role !== 'admin') {
                 const myU = currentUser.myUnits;
                 dataAttendance = dataAttendance.filter(d => myU.includes(d.unit));
                 dataPlans = dataPlans.filter(d => myU.includes(d.unit));
                 dataRecords = dataRecords.filter(d => myU.includes(d.unit));
                 dataReports = dataReports.filter(d => myU.includes(d.unit));
             }

             if (type === 'attendance') {
                 if(dataAttendance.length === 0) return alert("Tiada rekod.");
                 const uniqueUnits = [...new Set(dataAttendance.map(item => item.unit))];
                 contentHTML += `<div class="header"><h1>Analisis Kehadiran Aktiviti</h1><h2>Laporan Gabungan</h2><p>Tarikh: ${generatedDate}</p></div>`;
                 uniqueUnits.forEach(unitName => {
                     const records = dataAttendance.filter(d => d.unit === unitName);
                     contentHTML += `<div style="margin-top:30px;page-break-inside:avoid;"><h3 style="background:#eee;padding:5px;border:1px solid black;margin:0;">UNIT: ${unitName.toUpperCase()}</h3><table style="margin-top:0;"><thead><tr><th style="width:5%">Bil</th><th style="width:15%">Tarikh</th><th style="width:35%">Aktiviti</th><th style="width:10%">Hadir</th><th style="width:35%">Senarai Nama</th></tr></thead><tbody>${records.map((d, i) => `<tr><td style="text-align:center">${i + 1}</td><td style="text-align:center">${d.date}</td><td>${d.title}</td><td style="text-align:center;font-weight:bold;">${d.names ? d.names.split(',').length : 0}</td><td style="font-size:9pt;">${d.names || '-'}</td></tr>`).join('')}</tbody></table></div>`;
                 });
             }
             else if (type === 'plans') {
                 if(dataPlans.length === 0) return alert("Tiada data.");
                 const uniqueUnits = [...new Set(dataPlans.map(item => item.unit))];
                 contentHTML += `<div class="header"><h1>Laporan Perancangan Tahunan</h1><h2>Laporan Gabungan</h2></div>`;
                 uniqueUnits.forEach(unitName => {
                     const plans = dataPlans.filter(p => p.unit === unitName);
                     contentHTML += `<div style="margin-top:30px;page-break-inside:avoid;"><h3 style="background:#eee;padding:5px;border:1px solid black;margin:0;">UNIT: ${unitName.toUpperCase()}</h3><table style="margin-top:0;"><thead><tr><th style="width:15%">Tarikh</th><th style="width:40%">Program</th><th style="width:30%">Objektif</th><th style="width:15%">Status</th></tr></thead><tbody>${plans.map(p => `<tr><td style="text-align:center">${p.date}</td><td>${p.title}</td><td>${p.description}</td><td style="text-align:center;">${p.status}</td></tr>`).join('')}</tbody></table></div>`;
                 });
             }
             else if (type === 'merit') {
                 if(dataRecords.length === 0) return alert("Tiada rekod.");
                 const uniqueUnits = [...new Set(dataRecords.map(item => item.unit))];
                 contentHTML += `<div class="header"><h1>Rekod Pencapaian & Merit</h1><h2>Laporan Gabungan</h2></div>`;
                 uniqueUnits.forEach(unitName => {
                     const records = dataRecords.filter(r => r.unit === unitName);
                     contentHTML += `<div style="margin-top:30px;page-break-inside:avoid;"><h3 style="background:#eee;padding:5px;border:1px solid black;margin:0;">UNIT: ${unitName.toUpperCase()}</h3><table style="margin-top:0;"><thead><tr><th style="width:5%">Bil</th><th style="width:30%">Nama Murid</th><th style="width:30%">Acara</th><th style="width:20%">Pencapaian</th><th style="width:15%">Peringkat</th></tr></thead><tbody>${records.map((r, i) => `<tr><td style="text-align:center">${i + 1}</td><td>${r.names}</td><td>${r.title}</td><td style="text-align:center">${r.description}</td><td style="text-align:center">${r.venue}</td></tr>`).join('')}</tbody></table></div>`;
                 });
             }
             else if (type === 'full_reports') {
                 if(dataReports.length === 0) return alert("Tiada laporan.");
                 contentHTML = dataReports.map(r => `
                     <div class="report-page"><div class="header" style="border:none; margin-bottom:10px;"><h1>Laporan Aktiviti</h1><h2>${r.unit}</h2></div><table style="margin-bottom:20px;"><tr><td style="width:150px;font-weight:bold;background:#eee;">Tarikh</td><td>${r.date}</td></tr><tr><td style="font-weight:bold;background:#eee;">Tajuk Aktiviti</td><td>${r.title}</td></tr></table><div style="text-align:center;margin-bottom:20px;">${r.image ? `<img src="${r.image}" class="rpt-img">` : '<p style="border:1px dashed #999;padding:20px;">[Tiada Gambar]</p>'}</div><div style="margin-bottom:20px;"><strong>Ulasan:</strong><p style="text-align:justify;border:1px solid #ccc;padding:10px;">${r.description || '-'}</p></div><div><strong>Kehadiran:</strong><div style="font-size:10pt;border:1px solid #ccc;padding:10px;background:#f9f9f9;font-family:monospace;white-space:pre-wrap;">${r.names || "Tiada senarai nama."}</div></div><div class="footer"><div class="signature-box"><p>Disediakan oleh,</p><br><br><p>_______________________</p><p><strong>${currentUser.name}</strong></p></div></div></div>
                 `).join('');
             }

             if (contentHTML) {
                 if (type !== 'full_reports') {
                     contentHTML += `<div class="footer" style="margin-top:50px;"><div class="signature-box"><p>Disahkan oleh,</p><br><br><p>_______________________</p><p>Pentadbir</p></div><div class="signature-box"><p>Disediakan oleh,</p><br><br><p>_______________________</p><p>${currentUser.name}</p></div></div>`;
                 }
                 const printWindow = window.open('', '_blank', 'width=900,height=700');
                 printWindow.document.write(`<html><head><title>Cetak</title><style>@page{size:A4;margin:2cm;}body{font-family:'Times New Roman';padding:20px;}.header{text-align:center;border-bottom:2px solid black;margin-bottom:20px;}.header h1{font-size:18pt;margin:0;}.header h2{font-size:14pt;margin:5px 0;}table{width:100%;border-collapse:collapse;font-size:11pt;}th,td{border:1px solid black;padding:8px;}th{background:#f0f0f0;}.footer{display:flex;justify-content:flex-end;page-break-inside:avoid;}.signature-box{width:250px;text-align:center;margin-left:20px;}.report-page{page-break-after:always;padding-bottom:20px;}.rpt-img{max-height:350px;max-width:100%;object-fit:contain;border:1px solid #ccc;display:block;margin:10px auto;}</style></head><body>${contentHTML}<script>window.onload=function(){setTimeout(function(){window.print();},500);}`+'<'+'/script></body></html>');
                 printWindow.document.close();
             }
        }

        // --- SHARED UTILS ---
        function toggleImgMode(mode) { 
            document.getElementById('rpt-img-url').classList.toggle('hidden', mode !== 'url'); 
            document.getElementById('rpt-img-file').classList.toggle('hidden', mode !== 'file'); 
        }
        function convertBase64(input) {
            if(input.files[0].size > 50000) { alert("Fail terlalu besar (max 50KB). Sila guna URL."); input.value=""; return; }
            const r = new FileReader(); r.onload = e => document.getElementById('rpt-img-final').value = e.target.result; r.readAsDataURL(input.files[0]);
        }
        function handleCSVImport(input) {
             Papa.parse(input.files[0], { header: true, complete: async function(res) {
                 const rows = res.data.filter(r => r.name).map(r => ({ name: r.name, gender: r.gender||"L", unit: r.unit||"Umum", year: r.year||"1" }));
                 if(confirm(`Import ${rows.length} murid?`)) { showLoader(true); await callApi('batch_create', 'students_master', rows); showLoader(false); loadAllData(); }
             }});
        }
        async function deleteData(col, id) { if(confirm("Padam data ini?")) { showLoader(true); await callApi('delete', col, { doc_id: id }); showLoader(false); loadAllData(); } }
        
        // UI & NAVIGATION
        function closeModal(id) { document.getElementById(id).classList.replace('flex', 'hidden'); }
        function showPage(id) { 
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden')); 
            document.getElementById('page-' + id).classList.remove('hidden');
            
            document.getElementById('header-title').innerText = 
                id==='dashboard'?'Papan Pemuka': id==='students'?'Data Murid': id==='attendance'?'Kehadiran': 
                id==='reports'?'Laporan': id==='annual_plans'?'Perancangan': id==='merit'?'Rekod Merit': 
                id==='analysis'?'Analisis & Cetakan': id==='users'?'Pengurusan Guru': 'Sistem';

            if(id === 'students') renderStudentTable();
            if(id === 'attendance') renderAttendanceHistory();
            if(id === 'reports') renderReports();
            if(id === 'merit') renderMerit();
            if(id === 'annual_plans') renderAnnualPlans();
            if(id === 'users') renderUsers();

            // Mobile: Close sidebar after click
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        }

        // AUTO START
        if (localStorage.getItem('kms_user')) { 
            currentUser = JSON.parse(localStorage.getItem('kms_user')); 
            // Refresh logic units just in case
            if(!currentUser.myUnits) currentUser.myUnits=[currentUser.uniform,currentUser.club,currentUser.sport].filter(u => u && u!=='-'); 
            initApp(); 
        }
    </script>
</body>
</html>




